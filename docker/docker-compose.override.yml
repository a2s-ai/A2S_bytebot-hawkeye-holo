# Docker Compose Override - Cross-Platform Optimizations
# This file is automatically loaded by Docker Compose.
#
# 1. Force x86_64 Architecture
#    - Ensures consistent builds across Mac (Apple Silicon), Linux, and Windows
#    - On Apple Silicon: Uses Rosetta 2 emulation (~20% slower but stable)
#    - On x86_64 systems: Native performance, no emulation
#    - Benefits: Consistent OpenCV binaries, no platform-specific build issues
#
# 2. GPU Configuration for Holo 1.5-7B
#    - Supports both modern CDI and legacy nvidia-docker runtime
#    - Automatically enables NVIDIA GPU if nvidia-container-toolkit is installed
#    - Falls back to CPU if GPU not available (no errors)
#    - Apple Silicon: GPU config ignored (no NVIDIA support in Docker)

services:
  bytebot-agent:
    platform: linux/amd64

  bytebot-desktop:
    platform: linux/amd64

  bytebot-ui:
    platform: linux/amd64

  bytebot-holo:
    platform: linux/amd64

    # GPU Support - Multiple fallback strategies for maximum compatibility
    # Strategy 1: Modern approach (Docker Compose 2.3+, CDI-compatible)
    # Strategy 2: Legacy runtime (older nvidia-docker setups)
    # Docker applies what's supported on the host automatically

    # Legacy runtime support (for older setups without CDI)
    # Comment out if it causes issues on your system
    runtime: nvidia

    # Modern device reservation (preferred, works with CDI)
    # Docker gracefully ignores if nvidia-container-toolkit not available
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: all
              capabilities: [gpu, compute, utility]

    # NVIDIA environment variables (required for both legacy and modern)
    environment:
      - NVIDIA_VISIBLE_DEVICES=all
      - NVIDIA_DRIVER_CAPABILITIES=compute,utility
      # Disable NVIDIA requirement check (allows CPU fallback)
      - NVIDIA_REQUIRE_CUDA=

    # Explicit device request (docker compose --gpus equivalent)
    device_requests:
      - driver: nvidia
        count: -1
        capabilities:
          - gpu
          - compute
          - utility

  bytebot-llm-proxy:
    platform: linux/amd64
